# Super Mario Bros. 1-1 Clone with Pyxel – 設計ドキュメント

## 目次
1. [フォルダ構成の例](#フォルダ構成の例)  
2. [ゲーム内の主要コンポーネント](#ゲーム内の主要コンポーネント)  
3. [各コンポーネントの基本ロジック](#各コンポーネントの基本ロジック)  
   1. [プレイヤー(マリオ)の移動やアクション](#プレイヤーマリオの移動やアクション)  
   2. [マップ表示と衝突判定](#マップ表示と衝突判定)  
   3. [敵の挙動](#敵の挙動)  
   4. [カメラ(スクロール)](#カメラスクロール)  
   5. [HUD 表示](#hud-表示)  
4. [ゲームループ (Pyxel の基本フロー)](#ゲームループ-pyxel-の基本フロー)  
5. [レベルデータの管理](#レベルデータの管理)  
6. [スーパーマリオ ワールド1-1 特有のポイント](#スーパーマリオ-ワールド1-1-特有のポイント)  
7. [実装例のイメージ (超ざっくり)](#実装例のイメージ-超ざっくり)  
8. [まとめ](#まとめ)  

---

## フォルダ構成の例
project/
├─ assets/
│   ├─ tiles.png       // タイルセット画像(地面、レンガブロック、土管など)
│   ├─ mario.png       // マリオ用スプライト画像
│   ├─ enemies.png     // 敵(クリボー、ノコノコなど)用スプライト画像
│   └─ …その他BGMやSE
├─ data/
│   └─ level1.json     // マップやオブジェクト配置情報
├─ main.py             // メインのエントリーポイント
└─ …必要に応じてファイルを追加

- **assets/**  
  画像や音楽データなどのリソースをまとめるフォルダです。

- **data/**  
  ステージのマップデータや敵の配置など、パラメータファイルをまとめるフォルダです。  
  例: CSV や JSON 形式でタイル番号や敵の座標を定義します。

- **main.py**  
  ゲームのメインループ、主要クラスの初期化などのエントリーポイントです。

---

## ゲーム内の主要コンポーネント

1. **Game クラス (全体管理)**  
   - Pyxel アプリケーションクラスの役割を担う (`init`, `update`, `draw` メソッド)  
   - 他のクラス(プレイヤー、マップ、敵など)のインスタンスをまとめて管理し、相互連携を制御  
   - ゲームの状態管理 (タイトル画面、メインゲーム、ゲームオーバーなど)

2. **Player (マリオ) クラス**  
   - プレイヤーの位置 (`x, y`)  
   - 移動、ジャンプ、アニメーション(小マリオ、大マリオなどのステート)管理  
   - 当たり判定（床・壁・敵）  
   - ゲームパッド入力処理 (左右移動、ジャンプ)

3. **Map (マップ) クラス**  
   - Pyxel のタイルマップ機能でワールド1-1の地形(レンガ、パイプ、床)を表示  
   - スクロール処理 (マリオの動きに合わせて画面を横にスクロール)  
   - 衝突判定用にタイル情報を管理  
   - パワーアップアイテム (コイン、スーパーキノコ、ファイアフラワーなど) の配置管理

4. **Enemy (敵) クラス**  
   - 例: クリボー、ノコノコなど  
   - 各敵の位置 (`x, y`)、移動ロジック(左右往復、落下処理など)  
   - プレイヤーとの当たり判定 (踏まれたらやられる / 横から当たったらプレイヤーがダメージ)  
   - 複数の敵をまとめて管理する `EnemyManager` のようなクラスを用意しても良い

5. **Camera (カメラ / スクロール)**  
   - 画面左端・右端を定義し、プレイヤーの位置に応じて横スクロール  
   - ステージ終端(ゴール付近)を越えないよう制御

6. **UI / HUD**  
   - スコア、タイマー、残機、コイン枚数などの情報を表示  
   - `pyxel.text()` を使ってシンプルに描画  
   - 画面上部に固定して、スクロールに追従しない

---

## 各コンポーネントの基本ロジック

### プレイヤー(マリオ)の移動やアクション

1. **移動 (左右)**  
   - 左右キーの入力で速度 (`vx`) を更新  
   - 速度には最大値を設定し、緩やかな加速・減速を表現  
   - `x += vx` で位置を更新  
   - 衝突判定を行い、衝突していれば位置を補正  

2. **ジャンプ**  
   - ジャンプボタン(A/Bボタン)が押されたら、`vy` を負の値にして上方向へ移動させる  
   - 重力 (例: `gravity = 0.4`) を毎フレーム加算し、`y += vy` で垂直位置を更新  
   - 地面との衝突判定で着地したら `vy = 0` に設定。落下中は再ジャンプ不可にする  

3. **ステート管理**  
   - 「小マリオ」「スーパー(大)マリオ」「ファイアマリオ」など、状態によって当たり判定サイズやアニメーションを切り替え  
   - ダメージを受けた際に状態遷移  
   - ジャンプ中/地上時/走りなどでアニメーションフレームを制御

### マップ表示と衝突判定

1. **タイルマップの扱い**  
   - Pyxel の `pyxel.tilemap(0)` 等を用いてタイルマップを描画  
   - タイルサイズ (8x8) に合わせてステージ全体を作成  
   - ステージが長い場合は複数のタイルマップを連結させる、あるいはデータを分割

2. **衝突判定**  
   - プレイヤー座標からマップ上のタイルIDを逆算し、衝突すべきタイルか判定  
   - 「ブロックタイル」「床タイル」は衝突あり、「空白タイル」は衝突なし  
   - 水平/垂直移動後に衝突していれば、座標を補正して移動をキャンセル

3. **ブロック破壊 / アイテム出現**  
   - レンガブロックを頭突きしたときの破壊処理  
   - ？ブロックからアイテム (キノコ/コイン) が出る処理  
   - マップデータを書き換えるか、ブロックの状態を別途持つ方法で実装

### 敵の挙動

1. **移動ルーチン**  
   - クリボー: 一定速度で左右に移動し、端に達すると向きを変える  
   - ノコノコ: クリボー同様 + 踏まれたら甲羅状態になるなどの拡張

2. **当たり判定**  
   - プレイヤーが敵の頭上から当たれば敵を踏みつぶす  
   - 横や斜め下から当たればプレイヤーがダメージを受ける

### カメラ(スクロール)

- プレイヤーの `x` 座標が画面中央を超えたらカメラの `x` を更新  
- ステージの左端・右端でカメラが外へ行かないように `clamp` 処理  
- タイルやスプライトの描画時に `表示座標 - camera_x` を行い、スクロールを表現

### HUD 表示

- 画面上部にスコア、コイン数、残機、タイマーなどを `pyxel.text()` で描画  
- タイマーが 0 になるとゲームオーバー

---

## ゲームループ (Pyxel の基本フロー)

以下のステップを 1 フレームごとに実行します。

1. **`__init__`**  
   - Pyxel の初期化 (`pyxel.init(width, height, caption="...")`)  
   - 画像/音楽の読み込み (`pyxel.load("...")`)  
   - プレイヤー・マップ・敵などのインスタンス生成

2. **`update()`**  
   - 入力処理 (左右移動やジャンプなど)  
   - プレイヤーや敵の座標・アニメーションの更新  
   - 当たり判定 (マップ/敵との衝突)  
   - カメラ(スクロール)の更新  
   - ゲーム状態 (タイトル/ゲーム中/ゲームオーバー等) で処理を分岐

3. **`draw()`**  
   - 画面をクリア (`pyxel.cls(0)`)  
   - タイルマップ描画 (カメラ座標を考慮)  
   - プレイヤーや敵の描画  
   - HUD 情報を描画

---

## レベルデータの管理

JSON でマップやオブジェクトを定義する例:

```jsonc
{
  "tileset": "assets/tiles.png",
  "width": 256,
  "height": 32,
  "tile_data": [
    [0, 0, 0, 0, ...],
    [0, 1, 1, 0, ...],
    ...
  ],
  "objects": [
    {"type": "goomba", "x": 80,  "y": 160},
    {"type": "koopa",  "x": 120, "y": 160},
    {"type": "pipe",   "x": 200, "y": 144}
    ...
  ]
}
```
- tile_data で地形を管理 (タイル番号の2次元配列)
- objects で敵や土管などの配置を管理 (オブジェクトの種別と座標)
- 読み込んだデータをもとに Map や EnemyManager を初期化していく

---

## スーパーマリオ ワールド1-1 特有のポイント

1. **階段状の地形や足場**  
   - 1-1 は地形が階段状になっている部分も多く、落下することがあまりありません。  
   - 当たり判定ロジックを正しく処理できるように注意します。

2. **?ブロックの配置やコイン配置**  
   - 1-1 ならではの位置にブロックやコインが並んでいます。  
   - 配置データをしっかり反映して再現。

3. **土管の衝突判定**  
   - 上からは乗れるが、横からは壁扱いにする。

4. **ゴールポールとフラッグ演出**  
   - 画面右端にポールを配置し、接触時にクリア演出 (フラッグ降下、スコア加算など)。

5. **タイマーの設定**  
   - 実際のスーパーマリオは 400秒スタート（画面表示は 300 の場合も）  
   - 0 になるとミス扱いにする。

6. **カメラ開始位置**  
   - スタート直後のカメラは (0, 0) に固定。  
   - プレイヤーが右へ動き出してからカメラをスクロールさせる。


---

## 実装例のイメージ (超ざっくり)

```python
import pyxel

class Game:
    def __init__(self):
        pyxel.init(256, 224, caption="Super Mario 1-1 Clone")
        pyxel.load("assets/resource.pyxres")

        self.map = Map("data/level1.json")
        self.player = Player(16, 192)  # スタート位置 (例)
        self.enemies = EnemyManager("data/level1.json")
        self.camera_x = 0

        # Pyxel のメインループ開始
        pyxel.run(self.update, self.draw)

    def update(self):
        # タイトル / ゲームオーバーのステートがあればここで分岐
        
        self.player.update()
        self.enemies.update()

        # 衝突判定
        self.map.check_collision(self.player)
        self.enemies.check_collision(self.player)

        # カメラ更新
        self.camera_x = max(0, self.player.x - 100)
        self.camera_x = min(self.camera_x, self.map.width_px - pyxel.width)

    def draw(self):
        pyxel.cls(0)
        self.map.draw(self.camera_x)
        self.player.draw(self.camera_x)
        self.enemies.draw(self.camera_x)
        self.draw_hud()

    def draw_hud(self):
        pyxel.text(10, 5, f"SCORE: {self.player.score}", 7)
        pyxel.text(100, 5, f"TIME: {self.player.time}", 7)
        # ほかの情報 (コイン、残機など)

if __name__ == "__main__":
    Game()
```

---

## まとめ

- **クラス分割の考え方**  
  - Player / Map / Enemy / Camera / GameController といった役割を明確にすることで拡張しやすくなる

- **Pyxel の `update` / `draw` の基本サイクルを把握**  
  - 1フレームごとにキャラ・マップ・カメラなどを更新 → 描画

- **タイルマップ + 敵・アイテムなどのオブジェクト管理**  
  - タイルマップは 2次元配列を使い、衝突判定を行う  
  - 敵やアイテムは別データ（リストなど）で管理し、それぞれ座標更新・衝突処理を実装

- **ステージクリア、ゲームオーバーなどの状態管理**  
  - タイトル → プレイ中 → ゴール → リザルト(または次ステージ) → ゲームオーバー  
  - 状態フラグやステートマシンで制御

